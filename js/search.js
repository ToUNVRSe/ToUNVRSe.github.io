(()=>{let e,t=!1,n=!1,r=!1;const o=config.root+"search.json",s=getElement("#search-input"),l=getElement("nav"),a=config.search.activeHolder,i=config.search.blurHolder,c=config.search.noResult,u=getElement(".search-popup");function d(){n=!0,fetch(o).then(e=>e.text()).then(n=>{t=!0,e=JSON.parse(n),!0===r&&v()}).catch(()=>n=!1)}function h(e,t,n){let r=e.length;if(0===r)return[];let o=0,s=[],l=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,o))>-1;)l.push({position:s,word:e}),o=s+r;return l}function g(e,t,n,r){let o=n[n.length-1],s=o.position,l=o.word,a=[],i=0;for(;s+l.length<=t&&0!==n.length;){l===r&&i++,a.push({position:s,length:l.length});let e=s+l.length;for(n.pop();0!==n.length&&(o=n[n.length-1],s=o.position,l=o.word,e>s);)n.pop()}return{hits:a,start:e,end:t,TextCount:i}}function p(e,t){let n="",r=t.start;return t.hits.forEach(t=>{n+=e.substring(r,t.position);let o=t.position+t.length;n+=`<nobr class="search-keyword">${e.substring(t.position,o)}</nobr>`,r=o}),n+=e.substring(r,t.end),n}function m(){document.querySelector(".up")&&document.querySelector(".closed")&&getElement(".navBtn").classList.remove("expanded"),getElement("#search-result").querySelectorAll("a").forEach(e=>e.setAttribute("tabindex",-1)),document.body.classList.remove("blur"),u.classList.remove("open")}function f(){document.body.classList.add("blur"),document.querySelector(".up")&&document.querySelector(".closed")&&getElement(".navBtn").classList.add("expanded"),getElement("#search-result").removeAttribute("tabindex"),u.classList.add("open"),!0===t?(u.innerHTML="<div id='search-result'></div>",document.getElementById("search-result").innerHTML=""):getElement("#search-result").innerHTML='<div id="loading"><div><p>Loading...</p></div></div>'}function v(){let n=s.value.trim().toLowerCase();if(!n.length)return s.placeholder=a,void m();if(f(),!1===t)return;let r=n.split(/[-\s]+/);r.length>1&&r.push(n);let o=[];n.length>0&&e.forEach(e=>{if(!e.title)return;let t=0,s=0,l=0,a=e.title.trim(),i=a.toLowerCase(),c=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",u=c.toLowerCase(),d=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),m=[],f=[];if(r.forEach(e=>{let n=h(e,i,!1),r=h(e,u,!1);m=m.concat(n),f=f.concat(r),(n.length>0||r.length>0)&&t++,n.length>0&&s++,(n.length>0||r.length>0)&&l++}),m.length>0||f.length>0){[m,f].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)});let e=[],r=[];if(0!==m.length){let t=g(0,a.length,m,n);e.push(t)}let i=parseInt(config.top_n_per_article,10);i>=0&&(r=r.slice(0,i));let u="";if(0!==e.length?u+=`<a href="${d}" class="recent-post"><b class="search-result-title">${p(a,e[0])}</b>`:u+=`<a href="${d}" class="recent-post"><b class="search-result-title">${a}</b>`,null!==f&&0!==f.length){let e=f[f.length-1],t=e.position,r=e.word,o=t-20,s=t+80;o<0&&(o=0),s<t+r.length&&(s=t+r.length),s>c.length&&(s=c.length),u+=`<p class="search-result">${p(c,g(o,s,f,n))}...</p>`}else u+=`<p class="search-result">${c}...</p>`;u+="</a>",o.push({item:u,TextCount:t,TitleCount:s,ContentCount:l,id:o.length})}}),u.scroll({top:0,left:0});let l=getElement("#search-result");if(0===o.length)l.innerHTML=`<div id="no-result"><p>${format(c,`<b>${s.value}</b>`)}</p></div>`;else{o.sort((e,t)=>e.TextCount!==t.TextCount?t.TextCount-e.TextCount:e.TitleCount!==t.TitleCount?t.TitleCount-e.TitleCount:e.ContentCount!==t.ContentCount?t.ContentCount-e.ContentCount:t.id-e.id);let e="";o.forEach(t=>{e+=t.item}),l.innerHTML=e}"undefined"!=typeof pjax&&pjax.refresh(l)}config.search.preload&&d(),s.addEventListener("keypress",e=>{13===e.key&&v()});let E=0;function L(){l.classList.add("search"),l.classList.add("search-moving"),clearTimeout(E),E=setTimeout(()=>l.classList.remove("search-moving"),600),header.closeAll(),document.querySelector(".up")&&(getElement("main").style.pointerEvents="none"),s.placeholder=a,t||(n||d(),r=!0)}function T(){l.classList.contains("search")&&(l.classList.remove("search"),l.classList.add("search-moving"),clearTimeout(E),E=setTimeout(()=>l.classList.remove("search-moving"),600),m(),s.value="",s.placeholder=i,document.removeEventListener("mouseup",T),r=!1,getElement("main").style.pointerEvents="",s.blur())}s.addEventListener("keyup",()=>{l.classList.add("search"),v()}),s.addEventListener("focus",()=>{L()}),s.addEventListener("blur",e=>{e.relatedTarget&&e.relatedTarget.parentElement===getElement("#search-result")||T()}),u.addEventListener("focusout",e=>{(!e.relatedTarget||e.relatedTarget!==s&&e.relatedTarget.parentElement!==getElement("#search-result"))&&T()}),document.addEventListener("keyup",e=>{"Escape"===e.key?T():"f"!==e.key||["INPUT","TEXTAREA"].includes(e.target.tagName)||(document.querySelector(".up")||(getElement(".navBtn").classList.remove("hide"),header.open()),L(),s.focus())}),document.addEventListener("click",e=>{"A"!==e.target.tagName&&"A"!==e.target.parentElement.tagName||T()})})();